<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>BCTA 답변 및 평가</title>
</head>
<body>
  <h1>✏️ 질문에 답해주세요</h1>

  <div id="questionDisplay" style="white-space: pre-wrap; font-size: 18px;"></div>
  <textarea id="answerInput" rows="6" cols="60" placeholder="여기에 답변을 입력하세요..."></textarea><br><br>

  <button onclick="submitAnswer()">다음 질문</button>

  <script>
    let currentIndex = 1;
    const maxQuestions = 10; // 최대 질문 개수 (이후 자동으로 변경 가능)
    const target = localStorage.getItem("target");
    const evaluation = localStorage.getItem("evaluationType");

    // 질문 표시
    function loadQuestion(index) {
      const questionKey = `question_${index}`;
      const q = localStorage.getItem(questionKey);
      if (q) {
        const parsed = JSON.parse(q);
        document.getElementById("questionDisplay").textContent = `${index}. ${parsed.question}`;
      } else {
        document.getElementById("questionDisplay").textContent = `질문을 불러오는 중입니다...`;
      }
    }

    // 답변 제출
    async function submitAnswer() {
      const answer = document.getElementById("answerInput").value.trim();
      if (!answer) {
        alert("답변을 입력해주세요.");
        return;
      }

      // 저장
      localStorage.setItem(`answer_${currentIndex}`, answer);

      // 백그라운드 평가 요청 (점수만 반환)
      fetch('/api/evaluate-answer', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
          question: JSON.parse(localStorage.getItem(`question_${currentIndex}`)).question,
          answer: answer,
          evaluation: evaluation
        })
      })
      .then(res => res.json())
      .then(data => {
        localStorage.setItem(`score_${currentIndex}`, JSON.stringify(data.scores));
      });

      currentIndex++;

      // 다음 질문 있으면 로딩, 없으면 총평으로 이동
      if (localStorage.getItem(`question_${currentIndex}`)) {
        loadQuestion(currentIndex);
        document.getElementById("answerInput").value = "";
      } else {
        // 총평으로 이동
        localStorage.setItem("summary_ready", true);
        window.location.href = "summary.html";
      }
    }

    // 질문 2~n 미리 백그라운드 로딩
    async function preloadQuestions(startIndex) {
      for (let i = startIndex; i <= maxQuestions; i++) {
        const key = `question_${i}`;
        if (!localStorage.getItem(key)) {
          const res = await fetch('/api/generate-question', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
              target: target,
              evaluation: evaluation,
              index: i
            })
          });
          const data = await res.json();
          if (data && data.question) {
            localStorage.setItem(key, JSON.stringify(data.question));
          }
        }
      }
    }

    // 초기 실행
    window.onload = function() {
      loadQuestion(currentIndex);
      preloadQuestions(2);
    };
  </script>
</body>
</html>
