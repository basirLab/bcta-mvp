<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>BCTA 평가 페이지</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <div class="chat-box">
    <h2>📝 BCTA 평가 진행</h2>
    <div id="chatArea"></div>

    <div id="inputBox">
      <input type="text" id="userInput" placeholder="여기에 답변을 입력하세요">
      <button id="submitBtn">제출</button>
    </div>
  </div>

<script>
const questions = JSON.parse(localStorage.getItem("bcta_questions") || "[]");
let current = 0;
const answers = [];

const chatArea = document.getElementById("chatArea");
const userInput = document.getElementById("userInput");
const submitBtn = document.getElementById("submitBtn");

function showQuestion(index) {
  const q = questions[index];
  if (!q) {
    chatArea.innerHTML += `<div class="message"><div class="question">✅ 모든 질문에 답변하셨습니다. GPT 평가를 진행합니다...</div></div>`;
    document.getElementById("inputBox").style.display = "none";
    evaluateWithGPT();  // 👉 평가 요청 함수 호출
    return;
  }

  const tagHTML = `
    <div class="tags">
      <span><strong>주제:</strong> ${q.tags.주제}</span> |
      <span><strong>사고기능:</strong> ${q.tags.사고기능}</span> |
      <span><strong>정서:</strong> ${q.tags.정서}</span>
    </div>`;

  const questionHTML = `
    <div class="message">
      <div class="question">
        <strong>질문 ${index + 1}</strong><br>
        ${q.question}
        ${tagHTML}
      </div>
    </div>`;

  chatArea.innerHTML += questionHTML;
  userInput.value = "";
  userInput.focus();
  chatArea.scrollTop = chatArea.scrollHeight;
}

submitBtn.onclick = () => {
  const answer = userInput.value.trim();
  if (answer === "") return;

  answers.push({
    question: questions[current].question,
    type: questions[current].type,
    tags: questions[current].tags,
    answer: answer
  });

  const answerHTML = `
    <div class="message">
      <div class="answer">${answer}</div>
    </div>`;
  chatArea.innerHTML += answerHTML;
  current++;
  showQuestion(current);
};

window.onload = () => {
  showQuestion(current);
};

// 👉 평가 요청 함수
async function evaluateWithGPT() {
  const prompt = `
당신은 GPT 평가자입니다. 사용자의 질문-답변 목록과 각 항목의 태그(주제/사고기능/정서)를 기반으로 평가 기준에 따라 점수를 부여하십시오.

각 항목에 대해 다음과 같은 구조로 JSON으로 응답하십시오:
[
  {
    "질문": "질문 내용",
    "답변": "사용자 답변",
    "사고기능": "분석",  // 예시
    "점수": 4.5,
    "이유": "핵심 논리를 잘 설명하였음"
  },
  ...
]
질문-답변 목록:
${answers.map((item, i) => `Q${i + 1}: ${item.question}\nA${i + 1}: ${item.answer}\n[사고기능: ${item.tags.사고기능}]`).join('\n\n')}
`;

  try {
    const res = await fetch("/api/openai", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ prompt })
    });

    const data = await res.json();
    localStorage.setItem("bcta_result", data.result);
    window.location.href = "result.html";
  } catch (err) {
    alert("GPT 평가 요청에 실패했습니다.");
    console.error(err);
  }
}
</script>
</body>
</html>
ㄴ
